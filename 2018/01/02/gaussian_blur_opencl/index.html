<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>使用 OpenCL 实现图片高斯模糊 | gandalfliang的个人博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="高斯模糊（ https://zh.wikipedia.org/wiki/%E9%AB%98%E6%96%AF%E6%A8%A1%E7%B3%8A ）是一种常见的图像处理算法，使用高斯分布与图像做卷积，得到模糊的效果。其二维定义：  σ是正态分布的标准偏差。在应用的时候，假设σ为2.5。对于模糊半径为1，则高斯矩阵为3*3的一个矩阵，以[1,1]为中心，带入公式计算高斯矩阵的值，得到：">
<meta name="keywords" content="OpenCL,高性能计算,高斯模糊,图像处理">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 OpenCL 实现图片高斯模糊">
<meta property="og:url" content="http://gandalfliang.me/2018/01/02/gaussian_blur_opencl/index.html">
<meta property="og:site_name" content="gandalfliang的个人博客">
<meta property="og:description" content="高斯模糊（ https://zh.wikipedia.org/wiki/%E9%AB%98%E6%96%AF%E6%A8%A1%E7%B3%8A ）是一种常见的图像处理算法，使用高斯分布与图像做卷积，得到模糊的效果。其二维定义：  σ是正态分布的标准偏差。在应用的时候，假设σ为2.5。对于模糊半径为1，则高斯矩阵为3*3的一个矩阵，以[1,1]为中心，带入公式计算高斯矩阵的值，得到：">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/7/74/Normal_Distribution_PDF.svg/360px-Normal_Distribution_PDF.svg.png">
<meta property="og:updated_time" content="2018-02-12T06:59:10.591Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用 OpenCL 实现图片高斯模糊">
<meta name="twitter:description" content="高斯模糊（ https://zh.wikipedia.org/wiki/%E9%AB%98%E6%96%AF%E6%A8%A1%E7%B3%8A ）是一种常见的图像处理算法，使用高斯分布与图像做卷积，得到模糊的效果。其二维定义：  σ是正态分布的标准偏差。在应用的时候，假设σ为2.5。对于模糊半径为1，则高斯矩阵为3*3的一个矩阵，以[1,1]为中心，带入公式计算高斯矩阵的值，得到：">
<meta name="twitter:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/7/74/Normal_Distribution_PDF.svg/360px-Normal_Distribution_PDF.svg.png">
    

    

    
        <link rel="icon" href="/avatar.png" />
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">gandalfliang的个人博客</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="https://avatars3.githubusercontent.com/u/5707551?v=3&amp;s=460" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="https://avatars3.githubusercontent.com/u/5707551?v=3&amp;s=460" />
            <h2 id="name">Gandalfliang</h2>
            <h3 id="title">gandalfliang@outlook.com</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Guangzhou, China, 单身</span>
            <a id="follow" target="_blank" href="undefined">关注我</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                16
                <span>文章</span>
            </div>
            <div class="article-info-block">
                31
                <span>标签</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="http://github.com/gandalfliang" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main"><article id="post-gaussian_blur_opencl" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
            使用 OpenCL 实现图片高斯模糊
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/01/02/gaussian_blur_opencl/">
            <time datetime="2018-01-02T18:58:27.000Z" itemprop="datePublished">2018-01-02</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/OpenCL/">OpenCL</a>, <a class="tag-link" href="/tags/图像处理/">图像处理</a>, <a class="tag-link" href="/tags/高性能计算/">高性能计算</a>, <a class="tag-link" href="/tags/高斯模糊/">高斯模糊</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>高斯模糊（ <a href="https://zh.wikipedia.org/wiki/%E9%AB%98%E6%96%AF%E6%A8%A1%E7%B3%8A" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/%E9%AB%98%E6%96%AF%E6%A8%A1%E7%B3%8A</a> ）是一种常见的图像处理算法，使用高斯分布与图像做卷积，得到模糊的效果。其二维定义：<br><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/c36071d89adc2f4da470b45ce05c33ca93744577" alt=""> </p>
<p>σ是正态分布的标准偏差。在应用的时候，假设σ为2.5。对于模糊半径为1，则高斯矩阵为3*3的一个矩阵，以[1,1]为中心，带入公式计算高斯矩阵的值，得到：  </p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>0.0216996633</td>
<td>0.0235069655</td>
<td>0.0216996633  </td>
</tr>
<tr>
<td>0.0235069655</td>
<td>0.0254647918</td>
<td>0.0235069655  </td>
</tr>
<tr>
<td>0.0216996633</td>
<td>0.0235069655</td>
<td>0.0216996633  </td>
</tr>
</tbody>
</table>
<p>他们的和为 0.206291318，我们需要他们的和为1，因此与总和相除得到：  </p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>0.105189413</td>
<td>0.113950342</td>
<td>0.105189413  </td>
</tr>
<tr>
<td>0.113950342</td>
<td>0.123440929</td>
<td>0.113950342  </td>
</tr>
<tr>
<td>0.105189413</td>
<td>0.113950342</td>
<td>0.105189413  </td>
</tr>
</tbody>
</table>
<p>根据这个矩阵，对图像的每个像素点进行计算，计算的九个点的各rgb分量之和就是最终像素的rgb分量。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//计算高斯矩阵</span></span><br><span class="line">private <span class="keyword">void</span> ComputeWeightMatrix()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> center = Radius;</span><br><span class="line">    <span class="keyword">var</span> conBase = <span class="number">2</span> * <span class="built_in">Math</span>.Pow(Variance, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">var</span> conRoot = <span class="number">1</span> / (<span class="built_in">Math</span>.PI * conBase);</span><br><span class="line"></span><br><span class="line">    float sum = <span class="number">0</span>f;</span><br><span class="line">    <span class="keyword">for</span> (int x = -Radius; x &lt;= Radius; x++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (int y = Radius; y &gt;= -Radius; y--)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> weight = conRoot * <span class="built_in">Math</span>.Pow(<span class="built_in">Math</span>.E, -(x * x + y * y) / conBase);</span><br><span class="line">            _matrix[GridPosToArrayIndex(x, y, center, Radius)] = (float)weight;</span><br><span class="line">            sum += (float)weight;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; _matrix.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        _matrix[i] /= sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Compute</span></span><br><span class="line">public <span class="keyword">void</span> Compute(string imageFile)</span><br><span class="line">&#123;</span><br><span class="line">    using (<span class="keyword">var</span> bitmap = <span class="keyword">new</span> Bitmap(imageFile))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> datas = bitmap.LockBits(<span class="keyword">new</span> Rectangle(<span class="keyword">new</span> Point(), <span class="keyword">new</span> Size(bitmap.Width, bitmap.Height)),ImageLockMode.ReadOnly,bitmap.PixelFormat);</span><br><span class="line">        <span class="keyword">var</span> dataSize = datas.Stride * datas.Height;</span><br><span class="line">        <span class="keyword">var</span> argbs = <span class="keyword">new</span> byte[dataSize];</span><br><span class="line">        <span class="keyword">var</span> dsts = <span class="keyword">new</span> byte[dataSize];</span><br><span class="line">        int matrixWidth = Radius * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">        Marshal.Copy(datas.Scan0, argbs, <span class="number">0</span>, dataSize);</span><br><span class="line"></span><br><span class="line">        Stopwatch sw=Stopwatch.StartNew();</span><br><span class="line">        <span class="keyword">for</span> (int y = <span class="number">0</span>; y &lt; bitmap.Height; y++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (int x = <span class="number">0</span>; x &lt; bitmap.Width; x++)</span><br><span class="line">            &#123;</span><br><span class="line">                float sumA = <span class="number">0</span>;</span><br><span class="line">                float sumR = <span class="number">0</span>;</span><br><span class="line">                float sumG = <span class="number">0</span>;</span><br><span class="line">                float sumB=<span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; _matrix.Length; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> pos = transform_pos(x, y, matrixWidth, bitmap.Width, bitmap.Height, Radius, i);</span><br><span class="line">                    <span class="keyword">var</span> position = pos.Y * datas.Stride + pos.X*<span class="number">4</span>;</span><br><span class="line">                    sumR += argbs[position] * _matrix[i];</span><br><span class="line">                    sumG += argbs[position + <span class="number">1</span>] * _matrix[i];</span><br><span class="line">                    sumB += argbs[position + <span class="number">2</span>] * _matrix[i];</span><br><span class="line">                    sumA += argbs[position + <span class="number">3</span>] * _matrix[i];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">var</span> dstPos = y * datas.Stride + x * <span class="number">4</span>;</span><br><span class="line">                dsts[dstPos] = (byte)sumR;</span><br><span class="line">                dsts[dstPos+<span class="number">1</span>] = (byte)sumG;</span><br><span class="line">                dsts[dstPos+<span class="number">2</span>] = (byte)sumB;</span><br><span class="line">                dsts[dstPos+<span class="number">3</span>] = (byte)sumA;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        bitmap.UnlockBits(datas);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> elapse = sw.Elapsed;</span><br><span class="line">        Console.WriteLine($<span class="string">"Costing: &#123;elapse&#125;"</span>);</span><br><span class="line">        Debug.WriteLine($<span class="string">"Costing: &#123;elapse&#125;"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> handle = GCHandle.Alloc(dsts, GCHandleType.Pinned);</span><br><span class="line">        using (<span class="keyword">var</span> dstBmp = <span class="keyword">new</span> Bitmap(datas.Width, datas.Height, datas.Stride, bitmap.PixelFormat,</span><br><span class="line">            handle.AddrOfPinnedObject()))</span><br><span class="line">        &#123;</span><br><span class="line">            dstBmp.Save(<span class="string">"processed_normal.bmp"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        handle.Free();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当然，这样能完成工作，但是耗时太长，对于3000*1920尺寸的图片处理需要2分51秒（Intel Core i7-4770)，这显然是不可接受的。<br>对于这种分别计算每个像素，且各像素间互不干扰的问题，使用OpenCL可以大幅降低时间消耗。  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    OpenCL 高斯模糊代码</span></span><br><span class="line"><span class="comment">    Copyright Gandalfliang</span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line">inline int2 transform_pos(int centerX,int centerY,int matrixWidth,int radius,int index)</span><br><span class="line">&#123;</span><br><span class="line">    int x=index%matrixWidth;</span><br><span class="line">    int offsetX=x-(radius+<span class="number">1</span>);</span><br><span class="line">    int y=index/matrixWidth;</span><br><span class="line">    int offsetY=radius-y;</span><br><span class="line">    <span class="keyword">return</span> (int2)(centerX+offsetX,centerY-offsetY);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sampler_t sampler_img=CLK_NORMALIZED_COORDS_FALSE|CLK_ADDRESS_CLAMP_TO_EDGE;</span><br><span class="line"></span><br><span class="line"><span class="comment">//opencl kernel 代码</span></span><br><span class="line">kernel <span class="keyword">void</span> gaussian_blur(</span><br><span class="line">    read_only image2d_t src,</span><br><span class="line">    global write_only char* dst,</span><br><span class="line">    global read_only float* matrix,</span><br><span class="line">    read_only int radius,</span><br><span class="line">	read_only int width)</span><br><span class="line">&#123;</span><br><span class="line">    int x=get_global_id(<span class="number">0</span>);</span><br><span class="line">    int y=get_global_id(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    float sumR,sumG,sumB,sumA;</span><br><span class="line">    int matrixWidth=radius*<span class="number">2</span>+<span class="number">1</span>;</span><br><span class="line">    int matrix_size=pow(matrixWidth,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;matrix_size;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        int2 pix=transform_pos(x,y,matrixWidth,radius,i);</span><br><span class="line">        uint4 rgba = read_imageui(src,sampler_img,pix);</span><br><span class="line">        sumR+=rgba.x*matrix[i];</span><br><span class="line">        sumG+=rgba.y*matrix[i];</span><br><span class="line">        sumB+=rgba.z*matrix[i];</span><br><span class="line">		sumA+=rgba.w*matrix[i];</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">	int loc=y*width*<span class="number">4</span>+x*<span class="number">4</span>;</span><br><span class="line">	dst[loc]=sumR;</span><br><span class="line">	dst[loc+<span class="number">1</span>]=sumG;</span><br><span class="line">	dst[loc+<span class="number">2</span>]=sumB;</span><br><span class="line">	dst[loc+<span class="number">3</span>]=sumA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Host代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> Compute_cl(string imageFile)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//选取设备</span></span><br><span class="line">    <span class="keyword">var</span> platform = ComputePlatform.Platforms.FirstOrDefault();</span><br><span class="line">    <span class="keyword">var</span> device = platform.Devices.FirstOrDefault();</span><br><span class="line">    <span class="comment">//设置相关上下文</span></span><br><span class="line">    <span class="keyword">var</span> properties = <span class="keyword">new</span> ComputeContextPropertyList(platform);</span><br><span class="line">    <span class="keyword">var</span> context = <span class="keyword">new</span> ComputeContext(<span class="keyword">new</span>[] &#123;device&#125;, properties, <span class="literal">null</span>, IntPtr.Zero);</span><br><span class="line">    <span class="comment">//命令队列，用于控制执行的代码</span></span><br><span class="line">    ComputeCommandQueue commands = <span class="keyword">new</span> ComputeCommandQueue(context, context.Devices[<span class="number">0</span>],</span><br><span class="line">        ComputeCommandQueueFlags.None);</span><br><span class="line">    <span class="comment">//读取opencl代码</span></span><br><span class="line">    <span class="keyword">var</span> code = File.ReadAllText(@<span class="string">"gaussianblur.cl"</span>);</span><br><span class="line">    <span class="comment">//编译</span></span><br><span class="line">    <span class="keyword">var</span> program = <span class="keyword">new</span> ComputeProgram(context, code);</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        program.Build(<span class="keyword">new</span>[] &#123;device&#125;, <span class="literal">null</span>, <span class="literal">null</span>, IntPtr.Zero);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> images = CreateImageFromBitmap(imageFile, context,</span><br><span class="line">        ComputeMemoryFlags.ReadWrite | ComputeMemoryFlags.CopyHostPointer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建核心代码，就是cl代码中以kernel标识的函数</span></span><br><span class="line">    <span class="keyword">var</span> kernel = program.CreateKernel(<span class="string">"gaussian_blur"</span>);</span><br><span class="line">    <span class="comment">//矩阵规模</span></span><br><span class="line">    <span class="comment">//储存计算结果的数组</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建的核心代码函数以这种方式来传参</span></span><br><span class="line">    <span class="keyword">var</span> resultBuffer=<span class="keyword">new</span> ComputeBuffer&lt;char&gt;(context,ComputeMemoryFlags.WriteOnly, dstBytes.Length);</span><br><span class="line">    kernel.SetMemoryArgument(<span class="number">0</span>, images);</span><br><span class="line">    kernel.SetMemoryArgument(<span class="number">1</span>, resultBuffer);</span><br><span class="line">    kernel.SetMemoryArgument(<span class="number">2</span>, <span class="keyword">new</span> ComputeBuffer&lt;float&gt;(context,ComputeMemoryFlags.ReadOnly|ComputeMemoryFlags.CopyHostPointer,_matrix));</span><br><span class="line">    kernel.SetValueArgument(<span class="number">3</span>, Radius);</span><br><span class="line">    kernel.SetValueArgument(<span class="number">4</span>, (int)images.Width);</span><br><span class="line">    Console.WriteLine($<span class="string">"运行平台: &#123;platform.Name&#125;\n运行设备： &#123;device.Name&#125;\n"</span>);</span><br><span class="line">    Stopwatch sw = Stopwatch.StartNew();</span><br><span class="line">    <span class="keyword">var</span> climg = images;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行代码</span></span><br><span class="line">    commands.Execute(kernel, <span class="literal">null</span>, <span class="keyword">new</span> long[] &#123;climg.Width, climg.Height&#125;, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//read data</span></span><br><span class="line">    char[] resultArray = <span class="keyword">new</span> char[dstBytes.Length];</span><br><span class="line">    <span class="keyword">var</span> arrHandle = GCHandle.Alloc(resultArray, GCHandleType.Pinned);</span><br><span class="line">    commands.Read(resultBuffer, <span class="literal">true</span>, <span class="number">0</span>, dstBytes.Length, arrHandle.AddrOfPinnedObject(), <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//commands.ReadFromImage(images.Item2, processeddata.Scan0, true, null);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> resultHandle = GCHandle.Alloc(resultArray, GCHandleType.Pinned);</span><br><span class="line">    <span class="keyword">var</span> bmp=<span class="keyword">new</span> Bitmap(climg.Width,climg.Height, climg.Width*<span class="number">4</span>, PixelFormat.Format32bppArgb, resultHandle.AddrOfPinnedObject());</span><br><span class="line">    <span class="keyword">var</span> elapsed = sw.Elapsed;</span><br><span class="line">    Console.WriteLine($<span class="string">"耗时: &#123;elapsed.TotalMilliseconds&#125; ms\n"</span>);</span><br><span class="line">    kernel.Dispose();</span><br><span class="line"></span><br><span class="line">    bmp.Save(<span class="string">"processed_cl.bmp"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>相同尺寸的图片处理，使用 Intel Core i7-4770 自带的核显 HD4600 处理，耗时只需要164毫秒。</p>
<p>以下是相关测试结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">运行平台: Intel(R) OpenCL</span><br><span class="line">运行设备： Intel(R) HD Graphics 4600</span><br><span class="line">处理图片尺寸：790*501</span><br><span class="line">OpenCL处理耗时: 13.6597 ms</span><br><span class="line"></span><br><span class="line">处理图片尺寸：790*501</span><br><span class="line">常规方法耗时: 11482.9402 ms</span><br><span class="line"></span><br><span class="line">运行平台: Intel(R) OpenCL</span><br><span class="line">运行设备： Intel(R) HD Graphics 4600</span><br><span class="line">处理图片尺寸：1339*693</span><br><span class="line">OpenCL处理耗时: 33.0095 ms</span><br><span class="line"></span><br><span class="line">处理图片尺寸：1339*693</span><br><span class="line">常规方法耗时: 26908.9926 ms</span><br><span class="line"></span><br><span class="line">运行平台: Intel(R) OpenCL</span><br><span class="line">运行设备： Intel(R) HD Graphics 4600</span><br><span class="line">处理图片尺寸：1920*1080</span><br><span class="line">OpenCL处理耗时: 51.3885 ms</span><br><span class="line"></span><br><span class="line">处理图片尺寸：1920*1080</span><br><span class="line">常规方法耗时: 60147.3815 ms</span><br></pre></td></tr></table></figure></p>
<p>当然，常规方法都只使用了单线程，还未发挥多核CPU的威力，然而，可以预见的是，即使是使用多线程，提升也是有限的。</p>
<p>原图：<br><img src="http://omg3ewm0l.bkt.clouddn.com/screen_shot_gaus.png" alt=""><br>高斯模糊：<br><img src="http://omg3ewm0l.bkt.clouddn.com/processed_cl.bmp" alt=""></p>
<p>代码： <a href="https://github.com/gandalfliang/cloo_netstandard/tree/temp" target="_blank" rel="noopener">https://github.com/gandalfliang/cloo_netstandard/tree/temp</a> </p>
<font size="4" color="red">Update: 在nVidia的环境下会导致处理后的图片出现花屏现象，估计是cl代码的问题，又或者是nVidia的驱动有问题？下次再更新</font>
        
        </div>
        <footer class="article-footer">
            <div class="share-container">

    <div class="jiathis_style">
    <span class="jiathis_txt">分享到：</span>
    <a class="jiathis_button_qzone">QQ空间</a>
    <a class="jiathis_button_tsina">新浪微博</a>
    <a class="jiathis_button_tqq">腾讯微博</a>
    <a class="jiathis_button_weixin">微信</a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
    <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<style>
    .jiathis_style div:first-child:not(.jiadiv_01) {
        width: auto !important;
        border: none !important;
    }
    .jiathis_style .jiadiv_01 {
        margin: 10px 0;
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .jiathis_style .jiadiv_01 div:first-child {
        display: none;
    }
    .jiathis_style .jiadiv_02 {
        padding: 7px 0 !important;
    }
    .jiathis_style .jiadiv_02 .jiatitle {
        width: 85px;
        border: none;
        height: auto;
        margin: 3px 10px;
        padding: 6px 10px;
        border-radius: 4px;
    }
    .jiathis_style .jiadiv_02 .jiatitle:hover {
        border: none;
    }
    .jiathis_style .jiadiv_02 .jiatitle:nth-child(even) {
        margin-left: 0;
    }
    .jiathis_style .jtico:hover {
        opacity: 1;
    }
    .jiathis_style .ckepopBottom,
    .jiathis_style .centerBottom {
        width: auto !important;
        padding: 5px;
        background: #f7f7f7;
    }
</style>



</div>

            
    
        <a href="http://gandalfliang.me/2018/01/02/gaussian_blur_opencl/#comments" class="article-comment-link">评论</a>
    

        </footer>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2018/01/17/transparent_4k_window/" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">上一篇</strong>
            <div class="article-nav-title">
                
                    关于 WPF 透明窗口的内存占用
                
            </div>
        </a>
    
    
        <a href="/2017/12/25/cloo_net_standard/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">下一篇</strong>
            <div class="article-nav-title">.NET Standard CLOO</div>
        </a>
    
</nav>


    
</article>


    
    <section id="comments">
    
        
    <div id="uyan_frame"></div>

    
    </section>

</section>
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/02/12/lightweighted_shadoweffect/" class="thumbnail">
    
    
        <span style="background-image:url(https://upload.wikimedia.org/wikipedia/commons/thumb/7/74/Normal_Distribution_PDF.svg/360px-Normal_Distribution_PDF.svg.png)" alt="Light Weighted DropshadowEffect" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/技术/">技术</a></p>
                            <p class="item-title"><a href="/2018/02/12/lightweighted_shadoweffect/" class="title">Light Weighted DropshadowEffect</a></p>
                            <p class="item-date"><time datetime="2018-02-12T18:58:27.000Z" itemprop="datePublished">2018-02-12</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/01/17/transparent_4k_window/" class="thumbnail">
    
    
        <span style="background-image:url(http://www.iconshock.com/img_vista/FLAT/project_management/jpg/acceleration_graphic2_icon.jpg)" alt="关于 WPF 透明窗口的内存占用" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2018/01/17/transparent_4k_window/" class="title">关于 WPF 透明窗口的内存占用</a></p>
                            <p class="item-date"><time datetime="2018-01-17T16:01:38.000Z" itemprop="datePublished">2018-01-17</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/01/02/gaussian_blur_opencl/" class="thumbnail">
    
    
        <span style="background-image:url(https://upload.wikimedia.org/wikipedia/commons/thumb/7/74/Normal_Distribution_PDF.svg/360px-Normal_Distribution_PDF.svg.png)" alt="使用 OpenCL 实现图片高斯模糊" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2018/01/02/gaussian_blur_opencl/" class="title">使用 OpenCL 实现图片高斯模糊</a></p>
                            <p class="item-date"><time datetime="2018-01-02T18:58:27.000Z" itemprop="datePublished">2018-01-02</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/25/cloo_net_standard/" class="thumbnail">
    
    
        <span style="background-image:url(https://www.khronos.org/assets/uploads/ceimg/made/assets/uploads/apis/opencl_logo_75_75.png)" alt=".NET Standard CLOO" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/12/25/cloo_net_standard/" class="title">.NET Standard CLOO</a></p>
                            <p class="item-date"><time datetime="2017-12-25T16:01:38.000Z" itemprop="datePublished">2017-12-25</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/16/Gitsoler/" class="thumbnail">
    
    
        <span style="background-image:url(https://gandalfliang.gallerycdn.vsassets.io/extensions/gandalfliang/gitsoler/1.0/1513392739696/Microsoft.VisualStudio.Services.Icons.Default)" alt="Gitsoler" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/12/16/Gitsoler/" class="title">Gitsoler</a></p>
                            <p class="item-date"><time datetime="2017-12-16T16:01:38.000Z" itemprop="datePublished">2017-12-16</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/">技术</a><span class="category-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">4</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/2K/">2K</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BUG/">BUG</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CLOO/">CLOO</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/D3DImage/">D3DImage</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DirectX/">DirectX</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Extension/">Extension</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FFmpeg/">FFmpeg</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GPU/">GPU</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Guangzhou/">Guangzhou</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LayeredWindow/">LayeredWindow</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NET-Standard/">NET Standard</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nikon/">Nikon</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenCL/">OpenCL</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Perforator/">Perforator</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Performance/">Performance</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Profiling/">Profiling</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Timelapse/">Timelapse</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Video/">Video</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Visual-Studio/">Visual Studio</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WPF/">WPF</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/async-await/">async/await</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/单反/">单反</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/图像处理/">图像处理</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/曼德博集合/">曼德博集合</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/渲染/">渲染</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/翻译/">翻译</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/解码/">解码</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/通用计算/">通用计算</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/音视频/">音视频</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高性能计算/">高性能计算</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高斯模糊/">高斯模糊</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/2K/" style="font-size: 10px;">2K</a> <a href="/tags/BUG/" style="font-size: 10px;">BUG</a> <a href="/tags/CLOO/" style="font-size: 12.5px;">CLOO</a> <a href="/tags/D3DImage/" style="font-size: 12.5px;">D3DImage</a> <a href="/tags/DirectX/" style="font-size: 17.5px;">DirectX</a> <a href="/tags/Extension/" style="font-size: 10px;">Extension</a> <a href="/tags/FFmpeg/" style="font-size: 10px;">FFmpeg</a> <a href="/tags/GPU/" style="font-size: 10px;">GPU</a> <a href="/tags/Guangzhou/" style="font-size: 12.5px;">Guangzhou</a> <a href="/tags/LayeredWindow/" style="font-size: 10px;">LayeredWindow</a> <a href="/tags/NET-Standard/" style="font-size: 10px;">NET Standard</a> <a href="/tags/Nikon/" style="font-size: 12.5px;">Nikon</a> <a href="/tags/OpenCL/" style="font-size: 17.5px;">OpenCL</a> <a href="/tags/Perforator/" style="font-size: 10px;">Perforator</a> <a href="/tags/Performance/" style="font-size: 10px;">Performance</a> <a href="/tags/Profiling/" style="font-size: 10px;">Profiling</a> <a href="/tags/Timelapse/" style="font-size: 12.5px;">Timelapse</a> <a href="/tags/Video/" style="font-size: 12.5px;">Video</a> <a href="/tags/Visual-Studio/" style="font-size: 10px;">Visual Studio</a> <a href="/tags/WPF/" style="font-size: 20px;">WPF</a> <a href="/tags/async-await/" style="font-size: 10px;">async/await</a> <a href="/tags/单反/" style="font-size: 12.5px;">单反</a> <a href="/tags/图像处理/" style="font-size: 12.5px;">图像处理</a> <a href="/tags/曼德博集合/" style="font-size: 10px;">曼德博集合</a> <a href="/tags/渲染/" style="font-size: 12.5px;">渲染</a> <a href="/tags/翻译/" style="font-size: 12.5px;">翻译</a> <a href="/tags/解码/" style="font-size: 10px;">解码</a> <a href="/tags/通用计算/" style="font-size: 10px;">通用计算</a> <a href="/tags/音视频/" style="font-size: 10px;">音视频</a> <a href="/tags/高性能计算/" style="font-size: 15px;">高性能计算</a> <a href="/tags/高斯模糊/" style="font-size: 10px;">高斯模糊</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
                    <li>
                        <a href="http://lindexi.oschina.io/">林德熙的博客</a>
                    </li>
                
                    <li>
                        <a href="https://walterlv.github.io/blog/">吕毅的博客</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2018 gandalfliang<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        
    
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2127490"></script>



    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>